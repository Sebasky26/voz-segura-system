generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Usuario {
  id                 String              @id @default(uuid())
  email              String              @unique
  passwordHash       String
  rol                Rol                 @default(DENUNCIANTE)
  nombre             String?
  apellido           String?
  telefono           String?
  estado             EstadoUsuario       @default(ACTIVO)
  intentosFallidos   Int                 @default(0)
  bloqueadoHasta     DateTime?
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  logs               AuditoriaLog[]
  denuncias          Denuncia[]          @relation("DenuncianteUsuario")
  denunciasAsignadas Denuncia[]          @relation("SupervisorAsignado")
  mensajesChat       MensajeChat[]
  reglasSupervisor   ReglaSupervisor[]   // Relación inversa con ReglaSupervisor

  @@map("usuarios")
}

model Denuncia {
  id               String              @id @default(uuid())
  codigoAnonimo    String              @unique
  titulo           String
  descripcion      String
  categoria        CategoriaDenuncia
  estado           EstadoDenuncia      @default(PENDIENTE)
  prioridad        Prioridad           @default(MEDIA)
  denuncianteId    String?
  supervisorId     String?
  ubicacionGeneral String?
  derivadaA        String?
  fechaDerivacion  DateTime?
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt
  denunciante      Usuario?            @relation("DenuncianteUsuario", fields: [denuncianteId], references: [id])
  supervisor       Usuario?            @relation("SupervisorAsignado", fields: [supervisorId], references: [id])
  evidencias       Evidencia[]
  historial        HistorialDenuncia[]
  mensajes         MensajeChat[]

  @@map("denuncias")
}

model Evidencia {
  id             String   @id @default(uuid())
  denunciaId     String
  nombreOriginal String
  nombreCifrado  String
  tipo           String
  tamano         Int
  rutaCifrada    String
  createdAt      DateTime @default(now())
  denuncia       Denuncia @relation(fields: [denunciaId], references: [id], onDelete: Cascade)

  @@map("evidencias")
}

model HistorialDenuncia {
  id             String         @id @default(uuid())
  denunciaId     String
  estadoAnterior EstadoDenuncia
  estadoNuevo    EstadoDenuncia
  comentario     String?
  realizadoPor   String
  createdAt      DateTime       @default(now())
  denuncia       Denuncia       @relation(fields: [denunciaId], references: [id], onDelete: Cascade)

  @@map("historial_denuncias")
}

model MensajeChat {
  id             String      @id @default(uuid())
  usuarioId      String
  mensaje        String
  tipo           TipoMensaje @default(TEXTO)
  createdAt      DateTime    @default(now())
  denunciaId     String?
  esAnonimo      Boolean     @default(true)
  sala           String?
  destinatarioId String?
  denuncia       Denuncia?   @relation(fields: [denunciaId], references: [id], onDelete: Cascade)
  remitente      Usuario     @relation(fields: [usuarioId], references: [id])

  @@index([denunciaId])
  @@index([usuarioId])
  @@index([destinatarioId])
  @@index([sala])
  @@map("mensajes_chat")
}

model AuditoriaLog {
  id         String   @id @default(uuid())
  usuarioId  String?
  accion     String
  recurso    String?
  detalles   String?
  ipAddress  String?
  userAgent  String?
  exitoso    Boolean  @default(true)
  createdAt  DateTime @default(now())
  tabla      String
  registroId String?
  usuario    Usuario? @relation(fields: [usuarioId], references: [id])

  @@index([usuarioId])
  @@index([accion])
  @@index([tabla])
  @@index([createdAt])
  @@map("auditoria_logs")
}

model Configuracion {
  id          String   @id @default(uuid())
  clave       String   @unique
  valor       String
  descripcion String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("configuraciones")
}

// Regla para asignar supervisores según categoría y prioridad
// Permite múltiples reglas por categoría (una por cada nivel de prioridad)
// prioridad: 0=BAJA, 1=MEDIA, 2=ALTA, 3=URGENTE
model ReglaSupervisor {
  id           String            @id @default(uuid())
  nombre       String
  descripcion  String?
  prioridad    Int               @default(0) // Nivel de urgencia: 0-3
  activa       Boolean           @default(true)
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt
  categoria    CategoriaDenuncia
  supervisorId String
  supervisor   Usuario           @relation(fields: [supervisorId], references: [id], onDelete: Cascade)

  @@unique([categoria, prioridad, activa]) // Solo una regla activa por categoria+prioridad
  @@index([activa])
  @@index([categoria])
  @@index([prioridad])
  @@index([supervisorId])
  @@map("reglas_supervisor")
}

enum Rol {
  DENUNCIANTE
  SUPERVISOR
  ADMIN
}

enum EstadoUsuario {
  ACTIVO
  INACTIVO
  BLOQUEADO
}

enum CategoriaDenuncia {
  ACOSO_LABORAL
  DISCRIMINACION
  FALTA_DE_PAGO
  ACOSO_SEXUAL
  VIOLACION_DERECHOS
  OTRO
}

enum EstadoDenuncia {
  PENDIENTE
  EN_REVISION
  APROBADA
  DERIVADA
  CERRADA
  RECHAZADA
}

enum Prioridad {
  BAJA
  MEDIA
  ALTA
  URGENTE
}

enum TipoMensaje {
  TEXTO
  SISTEMA
  NOTIFICACION
}
